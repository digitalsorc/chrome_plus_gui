name: Build

on:
  push:
    paths-ignore:
      - ".clang-format"
      - ".gitignore"
      - "*.md"
      - "LICENSE"
      - "setdll/**"
      - "src/version.h"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/delete_old_workflow_runs.yml"
      - ".github/workflows/genReleaseNote.sh"
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (SemVer)'
        required: true

permissions:
  contents: read

jobs:
  build:
    strategy:
      matrix:
        include:
          - name: build_x64
            arch: x64

    name: ${{ matrix.name }}
    # windows-2022 is a supported runner; windows-2025 likely does not exist
    runs-on: windows-2022

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          submodules: 'true'

      - name: Update version.h
        # Use PowerShell on the Windows runner to safely update the header cross-platform.
        shell: pwsh
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "push") {
            $commit = git rev-parse --short HEAD
            $version = "alpha-$commit"
            Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append
            (Get-Content src/version.h) -replace '#define\s+RELEASE_VER_STR.*', "#define RELEASE_VER_STR `"$version`"" | Set-Content src/version.h
          } elseif ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch") {
            $versionInput = "${{ github.event.inputs.version }}"
            $version = $versionInput -replace '^[vV]', ''
            Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding ascii -Append
            $parts = $version -split '\.'
            $MAJOR = $parts[0]
            $MINOR = if ($parts.Length -gt 1) { $parts[1] } else { 0 }
            $PATCH = if ($parts.Length -gt 2) { $parts[2] } else { 0 }

            # Validate that MAJOR, MINOR, and PATCH are numeric to avoid cryptic RC/compile errors.
            if ($MAJOR -notmatch '^\d+$') {
              Write-Error "Invalid version '$versionInput': major version '$MAJOR' is not numeric. Expected format: MAJOR[.MINOR[.PATCH]] with numeric components."
              exit 1
            }
            if ($parts.Length -gt 1 -and $MINOR -notmatch '^\d+$') {
              Write-Error "Invalid version '$versionInput': minor version '$MINOR' is not numeric. Expected format: MAJOR[.MINOR[.PATCH]] with numeric components."
              exit 1
            }
            if ($parts.Length -gt 2 -and $PATCH -notmatch '^\d+$') {
              Write-Error "Invalid version '$versionInput': patch version '$PATCH' is not numeric. Expected format: MAJOR[.MINOR[.PATCH]] with numeric components."
              exit 1
            }
            (Get-Content src/version.h) `
              -replace '#define\s+RELEASE_VER_MAIN.*', "#define RELEASE_VER_MAIN $MAJOR" `
              -replace '#define\s+RELEASE_VER_SUB.*', "#define RELEASE_VER_SUB $MINOR" `
              -replace '#define\s+RELEASE_VER_FIX.*',  "#define RELEASE_VER_FIX $PATCH" |
              Set-Content src/version.h
          } else {
            Write-Output "No version change (event: $env:GITHUB_EVENT_NAME)"
          }

      - name: Setup Xmake
        uses: xmake-io/github-action-setup-xmake@v1

      - name: Configure Xmake (Windows/MSVC)
        # Use MSVC toolchain on the Windows runner to produce a working .exe reliably.
        shell: bash
        run: |
          # xmake -p windows is explicit; build release for the chosen arch
          xmake f -p windows -a ${{ matrix.arch }} -m release --vs="latest" --yes

      - name: Build Chrome++
        shell: bash
        run: |
          # build recursively and show verbose output
          xmake -v -r

      - name: Locate built .exe and copy to artifacts folder
        shell: pwsh
        run: |
          # Create artifacts dir
          $artdir = Join-Path -Path $PWD -ChildPath "artifacts"
          if (-Not (Test-Path $artdir)) { New-Item -ItemType Directory -Path $artdir | Out-Null }

          # Prefer DLL (expected output); fall back to EXE if present
          $artifact = Get-ChildItem -Path $PWD -Recurse -Include *.dll -File `
                        | Where-Object { $_.FullName -notmatch '\\.git\\' -and $_.FullName -notmatch '\\xmake\\' } `
                        | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($null -eq $artifact) {
            $artifact = Get-ChildItem -Path $PWD -Recurse -Include *.exe -File `
                          | Where-Object { $_.FullName -notmatch '\\.git\\' -and $_.FullName -notmatch '\\xmake\\' } `
                          | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          }

          if ($null -eq $artifact) {
            Write-Error "No build artifact found. Listing built files for debugging:"
            Get-ChildItem -Path $PWD -Recurse -File | Where-Object { $_.Extension -ne "" } | Select-Object -First 200
            exit 1
          }

          Write-Host "Found artifact: $($artifact.FullName)"
          Copy-Item -Path $artifact.FullName -Destination $artdir -Force
          Get-ChildItem -Path $artdir

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: chromeplus-${{ matrix.arch }}-${{ env.VERSION }}
          path: artifacts/*

  create_pr:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Git Configurations
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b release

      - name: Update version.h
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          sed -i 's/#define RELEASE_VER_MAIN .*/#define RELEASE_VER_MAIN '"$MAJOR"'/' src/version.h
          sed -i 's/#define RELEASE_VER_SUB .*/#define RELEASE_VER_SUB '"$MINOR"'/' src/version.h
          sed -i 's/#define RELEASE_VER_FIX .*/#define RELEASE_VER_FIX '"$PATCH"'/' src/version.h
          git add src/version.h
          git commit -m "build(release): bump version to $VERSION"
          git push origin release --force

      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --base main --head release --title "build(release): bump version to ${{ github.event.inputs.version }}" --body "Bump version to ${{ github.event.inputs.version }}"

      - name: Output Run ID
        run: echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_OUTPUT
